import*as e from"three";import{GLTFLoader as a}from"../jsm/GLTFLoader.js";import{CharacterControls as o}from"./charaterControls.js";import{OrbitControls as t}from"../jsm/OrbitControls.js";import{CSS2DRenderer as n,CSS2DObject as r}from"../jsm/CSS2DRenderer.js";let scene,camera,renderer,model,characterControls,orbitControls,keysPressed,labelRenderer,mixer,mixerseta,mixerseta1,mixerseta2,mixer3,mixerCozinheiro,mixergalinha,mixerPassaro,mixerVaca,rainGeo,rain,rainDrop,cloudGeo,rainCount=3e3,clouds=[],leavesMaterial,andando=!0,andandoPassaro=!0,girando=!0,flutuando=!0,galinha,passaro,floorParedefrontal,floorParedefrontal1,floorParedefrontal2,floorParedefrontal3,rock,clouund,mudardisplayBaixo,mudardisplayAlto;function init(){scene=new e.Scene,(camera=new e.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,300)).position.z=1,camera.rotation.x=1.16,camera.rotation.z=.27,camera.frustumCulling=!1,renderer=new e.WebGLRenderer({antialias:!0}),scene.fog=new e.FogExp2(8633855,.002),renderer.setClearColor(scene.fog.color),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,document.body.appendChild(renderer.domElement),(labelRenderer=new n).setSize(window.innerWidth,window.innerHeight),labelRenderer.domElement.style.position="absolute",labelRenderer.domElement.style.top="0px",labelRenderer.domElement.style.pointerEvents="none",document.body.appendChild(labelRenderer.domElement);let i=new e.TextureLoader,s=i.load("./textures/cerca.png");s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping,s.repeat.set(5,1);let d=new e.MeshPhongMaterial({map:s,transparent:!0,side:e.DoubleSide});function l(a,o,t,n,r,i){let s=new e.TextureLoader,d=s.load("./textures/estrada.png"),l=new e.PlaneGeometry(a,o),c=new e.MeshPhongMaterial({map:d,transparent:!0}),$=new e.Mesh(l,c);$.castShadow=!0,$.receiveShadow=!0,$.rotation.x=-Math.PI/2,$.rotation.z=i,$.position.set(t,n,r),scene.add($)}(function a(o,t,n,r,i,s){let l=new e.PlaneGeometry(20,1);(floorParedefrontal=new e.Mesh(l,d)).position.set(0,.5,-14.9),floorParedefrontal.rotation.y=0,scene.add(floorParedefrontal)})(20,1,0,.5,-14.9,0),function a(o,t,n,r,i,s){let l=new e.PlaneGeometry(20,1);(floorParedefrontal1=new e.Mesh(l,d)).position.set(10,.5,-5),floorParedefrontal1.rotation.y=s,scene.add(floorParedefrontal1)}(20,1,10,.5,-5,-Math.PI/2),function a(o,t,n,r,i,s){let l=new e.PlaneGeometry(20,1);(floorParedefrontal2=new e.Mesh(l,d)).position.set(-10,.5,-5),floorParedefrontal2.rotation.y=s,scene.add(floorParedefrontal2)}(20,1,-10,.5,-5,+Math.PI/2),function a(o,t,n,r,i,s){let l=new e.PlaneGeometry(20,1);(floorParedefrontal3=new e.Mesh(l,d)).position.set(0,.5,4.91),floorParedefrontal3.rotation.y=s,scene.add(floorParedefrontal3)}(20,1,0,.5,4.91,Math.PI),function a(){let o=new e.TextureLoader,t=o.load("./textures/MuchaTseBle.jpg"),n=new e.PlaneGeometry(30,30),r=new e.MeshPhongMaterial({map:t}),i=new e.Mesh(n,r);i.rotation.x=-Math.PI/2,i.position.set(0,0,-5),scene.add(i)}(),l(5,18,-8,.001,-6,0),l(5,16.6,1.7,.002,-8,1.6),l(5,11.5,8.5,.004,-.9,0),l(5,5.5,6.7,.004,-12.2,0),(orbitControls=new t(camera,renderer.domElement)).enableDamping=!0,orbitControls.minDistance=4,orbitControls.maxDistance=4,orbitControls.enablePan=!1,orbitControls.maxPolarAngle=Math.PI/2-.05,orbitControls.minPolarAngle=Math.PI/2-1,orbitControls.enableZoom=!1,orbitControls.update();let c=new e.AudioListener;scene.add(c);let $=new e.Audio(c),m=new e.AudioLoader;m.load("../sound/Golden.mp3",e=>{$.setBuffer(e),$.setLoop(!0),$.setVolume(.5)});let p=document.getElementById("paraTrilha"),h=document.getElementById("ativarTrilha");p.addEventListener("click",()=>{$.stop(),p.style.display="none",h.style.display="block"}),h.addEventListener("click",()=>{$.play(),p.style.display="block",h.style.display="none"});let f=document.createElement("button");f.textContent="Noite",f.setAttribute("id","noite");let w=document.createElement("button");w.textContent="Dia",w.setAttribute("id","dia"),w.style.display="none";let _=document.createElement("div");_.setAttribute("id","home"),_.appendChild(f),_.appendChild(w);let u=new r(_);scene.add(u),u.position.set(-7.5,1.5,-2);var x=document.createElement("div");x.setAttribute("class","balao");var b=document.createElement("p");b.setAttribute("class","mensagem"),b.textContent="Bem vindo, fique a vontade para escolher seu lanche!",x.appendChild(b);let y=new r(x);scene.add(y),y.position.set(9,2,-3);var v=document.querySelector(".pratosProntos"),g=document.querySelector(".legumes"),P=document.querySelector(".bebidas"),C=document.querySelector("#fechar1"),j=document.querySelector("#fechar2"),M=document.querySelector("#fechar3");C.addEventListener("click",()=>{v.classList.remove("ativo"),C.style.display="none"}),j.addEventListener("click",()=>{P.classList.remove("ativo"),j.style.display="none"}),M.addEventListener("click",()=>{g.classList.remove("ativo"),M.style.display="none"});var A=new e.Vector3;let E=new a().setPath("./models/");E.load("personagem.glb",function(a){(model=a.scene).scale.set(.25,.25,.25),model.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(model);let t=a.animations,n=new e.AnimationMixer(model),r=new Map;t.filter(e=>"Tpose"!=e.name).forEach(e=>{r.set(e.name,n.clipAction(e))}),characterControls=new o(model,n,r,orbitControls,camera,"Idle"),!function a(){let o=!1,t=new e.Box3().setFromObject(characterControls.model),n=[new e.Box3().setFromObject(B),new e.Box3().setFromObject(D),new e.Box3().setFromObject(G),new e.Box3().setFromObject(O),new e.Box3().setFromObject(I),new e.Box3().setFromObject(z),new e.Box3().setFromObject(F),new e.Box3().setFromObject(W),new e.Box3().setFromObject(k),new e.Box3().setFromObject(floorParedefrontal),new e.Box3().setFromObject(floorParedefrontal1),new e.Box3().setFromObject(floorParedefrontal2),new e.Box3().setFromObject(floorParedefrontal3),];var r=new e.Box3().setFromObject(D),i=new e.Box3().setFromObject(B),s=new e.Box3().setFromObject(k),d=new e.Box3().setFromObject(O);n.forEach(e=>{t.intersectsBox(e)&&(o=!0),t.intersectsBox(r)&&(x.style.display="block"),t.intersectsBox(i)&&(v.classList.add("ativo"),C.style.display="block"),t.intersectsBox(d)&&(g.classList.add("ativo"),M.style.display="block"),t.intersectsBox(s)&&(P.classList.add("ativo"),j.style.display="block")}),o?characterControls.model.position.copy(A):A.copy(characterControls.model.position),requestAnimationFrame(a)}()}),passaro=new e.Object3D,E.load("birds.glb",function(a){passaro.add(a.scene),passaro.scale.set(1,1,1),passaro.rotation.y=-1.5,passaro.position.set(-20,12,-30),mixerPassaro=new e.AnimationMixer(passaro),a.animations.forEach(e=>{mixerPassaro.clipAction(e).play(),mixerPassaro.clipAction(e).clampWhenFinished=!0}),scene.add(passaro)});let k=new e.Object3D;E.load("juice_shop.glb",function(e){k.add(e.scene),k.scale.set(30,30,30),k.rotation.y=-1.5,k.position.set(7,1,-14),k.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(k)});let O=new e.Object3D;E.load("correio.glb",function(e){O.add(e.scene),O.scale.set(1.3,1.3,1.3),O.rotation.y=0,O.position.set(-7.5,0,-14),scene.add(O)});let S=new e.Object3D;E.load("free_tree_1.glb",function(e){S.add(e.scene),S.scale.set(.01,.01,.01),S.rotation.y=0,S.position.set(-9,0,-14),scene.add(S)});let L=new e.Object3D;E.load("cow.glb",function(a){L.add(a.scene),L.scale.set(.25,.25,.25),L.rotation.y=1,L.position.set(-3,0,-14),scene.add(L),mixerVaca=new e.AnimationMixer(L),a.animations.forEach(e=>{mixerVaca.clipAction(e).play(),mixerVaca.clipAction(e).clampWhenFinished=!0})});let B=new e.Object3D;E.load("barbecue_grill.glb",function(e){B.add(e.scene),B.scale.set(2,2,2),B.rotation.y=3,B.position.set(9,0,-4.5),B.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(B)});let D=new e.Object3D;E.load("tonko.glb",function(a){D.add(a.scene),D.scale.set(.0012,.0012,.0012),D.rotation.y=-1,D.position.set(9,0,-3),D.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),mixerCozinheiro=new e.AnimationMixer(D),a.animations.forEach(e=>{mixerCozinheiro.clipAction(e).play(),mixerCozinheiro.clipAction(e).clampWhenFinished=!0}),scene.add(D)}),galinha=new e.Object3D,E.load("chicken_walkcycle.glb",function(a){galinha.add(a.scene),galinha.scale.set(4e-4,4e-4,4e-4),galinha.rotation.y=1.5,galinha.position.set(-9,0,-8),galinha.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),mixergalinha=new e.AnimationMixer(galinha),a.animations.forEach(e=>{mixergalinha.clipAction(e).play(),mixergalinha.clipAction(e).clampWhenFinished=!0}),scene.add(galinha)});let F=new e.Object3D;E.load("poste.glb",function(e){F.add(e.scene),F.scale.set(.3,.3,.3),F.position.set(9.5,0,-14),scene.add(F)});let z=new e.Object3D;E.load("firewood02.glb",function(e){z.add(e.scene),z.scale.set(3,3,3),z.position.set(0,0,-14.2),z.rotation.y=1.5,scene.add(z)});let G=new e.Object3D;E.load("message_board.glb",function(e){G.add(e.scene),G.scale.set(.6,.6,.6),G.position.set(11.5,-.3,6.2),G.rotation.y=.8,scene.add(G)});let I=new e.Object3D;E.load("well.glb",function(e){I.add(e.scene),I.scale.set(1,1,1),I.position.set(-2,0,-5),scene.add(I)});let W=new e.Object3D;E.load("druids_house_and_shop.glb",function(e){W.add(e.scene),W.scale.set(2.8,2.8,2.8),W.position.set(-7.5,0,1.4),W.rotation.y=1.6,scene.add(W)});let R=new e.Object3D;E.load("sun.glb",function(e){R.add(e.scene),R.scale.set(.05,.05,.05),R.position.set(50,30,-50),R.rotation.y=1.6,scene.add(R)});let T=new e.Object3D;E.load("lua.glb",function(e){T.add(e.scene),T.scale.set(5,5,5),T.position.set(50,30,-100),T.rotation.y=1.6});let V=new e.Object3D;E.load("directional_arrow_1.glb",function(a){V.add(a.scene),V.scale.set(.03,.03,.03),V.position.set(9,1,-4.5),V.rotation.y=2,mixerseta=new e.AnimationMixer(V),a.animations.forEach(e=>{mixerseta.clipAction(e).play(),mixerseta.clipAction(e).clampWhenFinished=!0}),scene.add(V)});let q=new e.Object3D;E.load("directional_arrow_1.glb",function(a){q.add(a.scene),q.scale.set(.03,.03,.03),q.position.set(7,2.5,-14),q.rotation.y=2.5,mixerseta1=new e.AnimationMixer(q),a.animations.forEach(e=>{mixerseta1.clipAction(e).play(),mixerseta1.clipAction(e).clampWhenFinished=!0}),scene.add(q)});let H=new e.Object3D;E.load("directional_arrow_1.glb",function(a){H.add(a.scene),H.scale.set(.03,.03,.03),H.position.set(-7.5,1.5,-14),H.rotation.y=3.5,mixerseta2=new e.AnimationMixer(H),a.animations.forEach(e=>{mixerseta2.clipAction(e).play(),mixerseta2.clipAction(e).clampWhenFinished=!0}),scene.add(H)});let U=new e.Object3D;for(let N=0;N<30;N++)E.load("pedra.glb",function(e){U.add(e.scene),(rock=U.clone()).scale.set(.1*Math.random()-.15,.1*Math.random()-.01,.1*Math.random()-.15),rock.position.set(20*Math.random()-10,0,20*Math.random()-15),window.innerWidth<600?scene.remove(rock):scene.add(rock)});let K=new e.Object3D;for(let Z=0;Z<20;Z++)E.load("clouds.glb",function(e){K.add(e.scene),(clouund=K.clone()).scale.x=.01,clouund.scale.z=.01,clouund.scale.y=.01*Math.random()-.001,clouund.position.set(100*Math.random()-55,15,100*Math.random()-55),clouund.traverse(function(e){e.isMesh&&(e.material.transparent=!0,e.material.opacity=.01)}),window.innerWidth<600?scene.remove(clouund):scene.add(clouund)});var J=new e.AmbientLight(16777215,.7);let Q=new e.DirectionalLight(16580566,1);Q.position.set(50,30,-50),Q.castShadow=!0,Q.shadow.camera.top=50,Q.shadow.camera.bottom=-50,Q.shadow.camera.left=-50,Q.shadow.camera.right=50,Q.shadow.camera.near=.1,Q.shadow.camera.far=200,Q.shadow.mapSize.width=4096,Q.shadow.mapSize.height=4096,scene.add(Q),scene.add(J);var X=new e.AmbientLight(9605778,1);let Y=new e.DirectionalLight(11531263,1);Y.position.set(50,30,-100),Y.castShadow=!0,Y.shadow.camera.top=50,Y.shadow.camera.bottom=-50,Y.shadow.camera.left=-50,Y.shadow.camera.right=50,Y.shadow.camera.near=.1,Y.shadow.camera.far=200,Y.shadow.mapSize.width=4096,Y.shadow.mapSize.height=4096;let ee=new e.PointLight(16579698,10,10,1);ee.position.set(9.5,2,-13);let ea=new e.PointLight(16719360,1,1,4);ea.position.set(9,1,-4.5);let eo=new e.PointLight(16777215,10,40,0);eo.position.set(50,30,-80);var et=!1;mudardisplayBaixo=document.querySelector(".display"),mudardisplayAlto=document.getElementById("adicionar"),mudardisplayBaixo.addEventListener("click",()=>{renderer.shadowMap.enabled=!1,Q.castShadow=!1,Y.castShadow=!1,scene.remove(eo),scene.remove(ea),scene.remove(ee),scene.remove(passaro),scene.remove(ep),scene.remove(Q),scene.remove(Y),scene.remove(galinha),scene.remove(clouund),et=!0}),mudardisplayAlto.addEventListener("click",()=>{renderer.shadowMap.enabled=!0,Q.castShadow=!0,Y.castShadow=!0,scene.add(passaro),scene.add(ep),scene.add(Q),scene.add(galinha),et=!1});let en=[],er=[];rainGeo=new e.BufferGeometry;for(let ei=0;ei<rainCount;ei++)rainDrop=new e.Vector3(400*Math.random()-200,500*Math.random()-250,400*Math.random()-200),en.push(400*Math.random()-200),en.push(500*Math.random()-250),en.push(400*Math.random()-200),er.push(30);rainGeo.setAttribute("position",new e.BufferAttribute(new Float32Array(en),4)),rainGeo.setAttribute("size",new e.BufferAttribute(new Float32Array(er),1));let es=new e.PointsMaterial({color:14417149,size:.2,transparent:!0});rain=new e.Points(rainGeo,es);let ed=document.getElementById("screen");f.addEventListener("click",function(){ed.addEventListener("animationend",function(){this.style.display="none"}),scene.fog=new e.FogExp2(1118495,.002),renderer.setClearColor(scene.fog.color),scene.remove(Q),scene.remove(J),scene.remove(passaro),scene.remove(R),scene.add(T),!0===et?(scene.remove(Y),scene.remove(eo),scene.remove(ea),scene.remove(ee)):(scene.add(Y),scene.add(ee),scene.add(ea),scene.add(eo)),scene.add(X),scene.add(rain),ed.style.display="block",f.style.display="none",w.style.display="block"}),w.addEventListener("click",function(){scene.fog=new e.FogExp2(8633855,.002),renderer.setClearColor(scene.fog.color),!0===et?(scene.remove(Q),scene.remove(passaro)):(scene.add(Q),scene.add(passaro)),scene.add(J),scene.add(R),scene.remove(eo),scene.remove(ea),scene.remove(ee),scene.remove(T),scene.remove(Y),scene.remove(X),scene.remove(rain),ed.style.display="block",f.style.display="block",w.style.display="none",ed.addEventListener("animationend",function(){this.style.display="none"})});let el=`
    varying vec2 vUv;
    uniform float time;
    
        void main() {
        vUv = uv;
        
        vec4 mvPosition = vec4( position, 1.0 );
        #ifdef USE_INSTANCING
            mvPosition = instanceMatrix * mvPosition;
        #endif
        
        float dispPower = 1.0 - cos( uv.y * 3.1416 / 2.0 );
        
        float displacement = sin( mvPosition.z + time * 3.0 ) * ( 0.02 * dispPower );
        mvPosition.z += displacement;

        vec4 modelViewPosition = modelViewMatrix * mvPosition;
        gl_Position = projectionMatrix * modelViewPosition;

        }
    `,ec=`
    varying vec2 vUv;
    
    void main() {
        vec3 baseColor = vec3( 0.61, 1.0, 0.6 );
        float clarity = ( vUv.y * 0.35 ) + 0.00001;
        gl_FragColor = vec4( baseColor * clarity, 1 );
    }
    `;leavesMaterial=new e.ShaderMaterial({vertexShader:el,fragmentShader:ec,uniforms:{time:{value:0}},side:e.DoubleSide});let e$=new e.Object3D,em=new e.PlaneGeometry(.01,.2,1);em.translate(0,.01,0);let ep=new e.InstancedMesh(em,leavesMaterial,16e4);scene.add(ep);for(let eh=0;eh<16e4;eh++)e$.position.set((Math.random()-.48)*13.5,0,(Math.random()-.58)*11.2),e$.scale.setScalar(.8+.8*Math.random()),e$.rotation.y=Math.random()*Math.PI,e$.updateMatrix(),ep.setMatrixAt(eh,e$.matrix);for(let ef=0;ef<6e4;ef++)e$.position.set((Math.random()-.56)*11.5,0,(Math.random()-2.85)*5.23),e$.scale.setScalar(.8+.8*Math.random()),e$.rotation.y=Math.random()*Math.PI,e$.updateMatrix(),ep.setMatrixAt(ef,e$.matrix);for(let ew=0;ew<1e4;ew++)e$.position.set((Math.random()- -4.6)*1.8,0,(Math.random()-2.8)*5.2),e$.scale.setScalar(.8+.8*Math.random()),e$.rotation.y=Math.random()*Math.PI,e$.updateMatrix(),ep.setMatrixAt(ew,e$.matrix);keysPressed={},document.addEventListener("keydown",e=>{e.shiftKey&&characterControls?characterControls.switchRunToggle():keysPressed[e.key.toLowerCase()]=!0},!1),document.addEventListener("keyup",e=>{keysPressed[e.key.toLowerCase()]=!1},!1),window.addEventListener("resize",function(){camera.aspect=this.window.innerWidth/this.window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(this.window.innerWidth,this.window.innerHeight),labelRenderer.setSize(this.window.innerWidth,this.window.innerHeight)}),animate()}let clock=new e.Clock;function animate(){let e=clock.getDelta();characterControls&&characterControls.update(e,keysPressed),mixer&&mixer.update(e),mixer3&&mixer3.update(e),mixerCozinheiro&&mixerCozinheiro.update(e),mixergalinha&&mixergalinha.update(e),mixerPassaro&&mixerPassaro.update(e),mixerVaca&&mixerVaca.update(e),mixerseta&&mixerseta.update(e),mixerseta1&&mixerseta1.update(e),mixerseta2&&mixerseta2.update(e),orbitControls.update(),!0==andando?(galinha.position.x+=.005,galinha.position.x>=9&&(andando=!1,galinha.rotation.y=-1.5)):(galinha.position.x-=.005,galinha.position.x<=-9&&(andando=!0,galinha.rotation.y=1.5)),!0==andandoPassaro?(passaro.position.x+=.03,passaro.position.x>=100&&(andandoPassaro=!1,passaro.rotation.y=1.5)):(passaro.position.x-=.03,passaro.position.x<=-100&&(andandoPassaro=!0,passaro.rotation.y=-1.5)),leavesMaterial.uniforms.time.value=clock.getElapsedTime(),leavesMaterial.uniformsNeedUpdate=!0,labelRenderer.render(scene,camera),renderer.render(scene,camera),requestAnimationFrame(animate)}init();