import*as e from"../build/three.module.js";import{GLTFLoader as t}from"../jsm/GLTFLoader.js";import{CharacterControls as n}from"./charaterControls.js";import{OrbitControls as a}from"../jsm/OrbitControls.js";import{CSS2DRenderer as o,CSS2DObject as r}from"../jsm/CSS2DRenderer.js";let scene,camera,renderer,model,characterControls,orbitControls,keysPressed,labelRenderer,mixer,mixerseta,mixerseta1,mixerseta2,mixer3,mixerCozinheiro,mixergalinha,mixerPassaro,mixerVaca,rainGeo,rain,rainDrop,cloudGeo,rainCount=3e3,clouds=[],leavesMaterial,andando=!0,andandoPassaro=!0,girando=!0,flutuando=!0,galinha,passaro,floorParedefrontal,floorParedefrontal1,floorParedefrontal2,floorParedefrontal3,rock,clouund,mudardisplayBaixo,mudardisplayAlto;function init(){scene=new e.Scene,(camera=new e.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,300)).position.z=1,camera.rotation.x=1.16,camera.rotation.z=.27,renderer=new e.WebGLRenderer({antialias:!0}),scene.fog=new e.FogExp2(8900331,.002),renderer.setClearColor(scene.fog.color),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,document.body.appendChild(renderer.domElement),(labelRenderer=new o).setSize(window.innerWidth,window.innerHeight),labelRenderer.domElement.style.position="absolute",labelRenderer.domElement.style.top="0px",labelRenderer.domElement.style.pointerEvents="none",document.body.appendChild(labelRenderer.domElement);let i=new e.TextureLoader,s=i.load("./textures/cerca.png");s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping,s.repeat.set(5,1);let l=new e.MeshPhongMaterial({map:s,transparent:!0,side:e.DoubleSide});function d(t,n,a,o,r,i){let s=new e.TextureLoader,l=s.load("./textures/estrada.png"),d=new e.PlaneGeometry(t,n),c=new e.MeshPhongMaterial({map:l,transparent:!0}),$=new e.Mesh(d,c);$.castShadow=!0,$.receiveShadow=!0,$.rotation.x=-Math.PI/2,$.rotation.z=i,$.position.set(a,o,r),scene.add($)}(function t(n,a,o,r,i,s){let d=new e.PlaneGeometry(20,1);(floorParedefrontal=new e.Mesh(d,l)).position.set(0,.5,-14.9),floorParedefrontal.rotation.y=0,scene.add(floorParedefrontal)})(20,1,0,.5,-14.9,0),function t(n,a,o,r,i,s){let d=new e.PlaneGeometry(20,1);(floorParedefrontal1=new e.Mesh(d,l)).position.set(10,.5,-5),floorParedefrontal1.rotation.y=s,scene.add(floorParedefrontal1)}(20,1,10,.5,-5,-Math.PI/2),function t(n,a,o,r,i,s){let d=new e.PlaneGeometry(20,1);(floorParedefrontal2=new e.Mesh(d,l)).position.set(-10,.5,-5),floorParedefrontal2.rotation.y=s,scene.add(floorParedefrontal2)}(20,1,-10,.5,-5,+Math.PI/2),function t(n,a,o,r,i,s){let d=new e.PlaneGeometry(20,1);(floorParedefrontal3=new e.Mesh(d,l)).position.set(0,.5,4.91),floorParedefrontal3.rotation.y=s,scene.add(floorParedefrontal3)}(20,1,0,.5,4.91,Math.PI),function t(){let n=new e.TextureLoader,a=n.load("./textures/MuchaTseBle.jpg"),o=new e.PlaneGeometry(30,30),r=new e.MeshPhongMaterial({map:a}),i=new e.Mesh(o,r);i.rotation.x=-Math.PI/2,i.position.set(0,0,-5),scene.add(i)}(),d(5,18,-8,.001,-6,0),d(5,16.6,1.7,.002,-8,1.6),d(5,11.5,8.5,.004,-.9,0),d(5,5.5,6.7,.004,-12.2,0),(orbitControls=new a(camera,renderer.domElement)).enableDamping=!0,orbitControls.minDistance=4,orbitControls.maxDistance=4,orbitControls.enablePan=!1,orbitControls.maxPolarAngle=Math.PI/2-.05,orbitControls.minPolarAngle=Math.PI/2-1,orbitControls.enableZoom=!1,orbitControls.update();let c=new e.AudioListener;scene.add(c);let $=new e.Audio(c),m=new e.AudioLoader;m.load("../sound/Golden.mp3",e=>{$.setBuffer(e),$.setLoop(!0),$.setVolume(.5)});let p=document.getElementById("paraTrilha"),h=document.getElementById("ativarTrilha");p.addEventListener("click",()=>{$.stop(),p.style.display="none",h.style.display="block"}),h.addEventListener("click",()=>{$.play(),p.style.display="block",h.style.display="none"});let _=document.createElement("button");_.textContent="Noite",_.setAttribute("id","noite");let f=document.createElement("button");f.textContent="Dia",f.setAttribute("id","dia"),f.style.display="none";let w=document.createElement("div");w.setAttribute("id","home"),w.appendChild(_),w.appendChild(f);let u=new r(w);scene.add(u),u.position.set(-7.5,1.5,-2);var b=document.createElement("div");b.setAttribute("class","balao");var x=document.createElement("p");x.setAttribute("class","mensagem"),x.textContent="Bem vindo, fique a vontade para escolher seu lanche!",b.appendChild(x);let y=new r(b);scene.add(y),y.position.set(9,2,-3);var v=document.querySelector(".pratosProntos"),g=document.querySelector(".legumes"),P=document.querySelector(".bebidas"),E=document.querySelector("#fechar1"),C=document.querySelector("#fechar2"),M=document.querySelector("#fechar3");E.addEventListener("click",()=>{v.classList.remove("ativo"),E.style.display="none"}),C.addEventListener("click",()=>{P.classList.remove("ativo"),C.style.display="none"}),M.addEventListener("click",()=>{g.classList.remove("ativo"),M.style.display="none"});let L=new e.CircleGeometry(.4,32),j=new e.MeshPhongMaterial({color:65280,transparent:!0}),A=new e.Mesh(L,j),S=new e.Mesh(L,j),k=new e.Mesh(L,j);A.rotation.x=-Math.PI/2,A.position.set(8,.01,-4.5),S.rotation.x=-Math.PI/2,S.position.set(7,.01,-12),k.rotation.x=-Math.PI/2,k.position.set(-7.5,.01,-13),scene.add(A),scene.add(S),scene.add(k);let O=document.createElement("button");O.textContent="Entrar",O.setAttribute("class","btnEntrar1");let B=new r(O);scene.add(B),B.position.set(8,1.5,-4.5);let D=document.createElement("button");D.textContent="Entrar",D.setAttribute("class","btnEntrar2");let F=new r(D);scene.add(F),F.position.set(7,1.5,-12);let z=document.createElement("button");z.textContent="Entrar",z.setAttribute("class","btnEntrar3");let I=new r(z);scene.add(I),I.position.set(-7.5,1.5,-13),O.addEventListener("click",()=>{v.classList.add("ativo"),E.style.display="block"}),D.addEventListener("click",()=>{P.classList.add("ativo"),C.style.display="block"}),z.addEventListener("click",()=>{g.classList.add("ativo"),M.style.display="block"});var G=new e.Vector3;let W=new t().setPath("./models/");W.load("personagem.glb",function(t){(model=t.scene).scale.set(.25,.25,.25),model.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(model);let a=t.animations,o=new e.AnimationMixer(model),r=new Map;a.filter(e=>"Tpose"!=e.name).forEach(e=>{r.set(e.name,o.clipAction(e))}),characterControls=new n(model,o,r,orbitControls,camera,"Idle"),!function t(){let n=!1,a=new e.Box3().setFromObject(characterControls.model),o=[new e.Box3().setFromObject(H),new e.Box3().setFromObject(U),new e.Box3().setFromObject(Z),new e.Box3().setFromObject(R),new e.Box3().setFromObject(J),new e.Box3().setFromObject(K),new e.Box3().setFromObject(N),new e.Box3().setFromObject(Q),new e.Box3().setFromObject(q),new e.Box3().setFromObject(floorParedefrontal),new e.Box3().setFromObject(floorParedefrontal1),new e.Box3().setFromObject(floorParedefrontal2),new e.Box3().setFromObject(floorParedefrontal3),];var r=new e.Box3().setFromObject(U),i=new e.Box3().setFromObject(A),s=new e.Box3().setFromObject(S),l=new e.Box3().setFromObject(k);o.forEach(e=>{a.intersectsBox(e)&&(n=!0),a.intersectsBox(r)&&(b.style.display="block"),a.intersectsBox(i)?document.querySelector(".btnEntrar1").classList.add("ativo"):document.querySelector(".btnEntrar1").classList.remove("ativo"),a.intersectsBox(l)?document.querySelector(".btnEntrar3").classList.add("ativo"):document.querySelector(".btnEntrar3").classList.remove("ativo"),a.intersectsBox(s)?document.querySelector(".btnEntrar2").classList.add("ativo"):document.querySelector(".btnEntrar2").classList.remove("ativo")}),n?characterControls.model.position.copy(G):G.copy(characterControls.model.position),requestAnimationFrame(t)}()}),passaro=new e.Object3D,W.load("birds.glb",function(t){passaro.add(t.scene),passaro.scale.set(1,1,1),passaro.rotation.y=-1.5,passaro.position.set(-20,12,-30),mixerPassaro=new e.AnimationMixer(passaro),t.animations.forEach(e=>{mixerPassaro.clipAction(e).play(),mixerPassaro.clipAction(e).clampWhenFinished=!0}),scene.add(passaro)});let q=new e.Object3D;W.load("juice_shop.glb",function(e){q.add(e.scene),q.scale.set(30,30,30),q.rotation.y=-1.5,q.position.set(7,1,-14),q.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(q)});let R=new e.Object3D;W.load("correio.glb",function(e){R.add(e.scene),R.scale.set(1.3,1.3,1.3),R.rotation.y=0,R.position.set(-7.5,0,-14),scene.add(R)});let T=new e.Object3D;W.load("free_tree_1.glb",function(e){T.add(e.scene),T.scale.set(.01,.01,.01),T.rotation.y=0,T.position.set(-9,0,-14),scene.add(T)});let V=new e.Object3D;W.load("cow.glb",function(t){V.add(t.scene),V.scale.set(.25,.25,.25),V.rotation.y=1,V.position.set(-3,0,-14),scene.add(V),mixerVaca=new e.AnimationMixer(V),t.animations.forEach(e=>{mixerVaca.clipAction(e).play(),mixerVaca.clipAction(e).clampWhenFinished=!0})});let H=new e.Object3D;W.load("barbecue_grill.glb",function(e){H.add(e.scene),H.scale.set(2,2,2),H.rotation.y=3,H.position.set(9,0,-4.5),H.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(H)});let U=new e.Object3D;W.load("tonko.glb",function(t){U.add(t.scene),U.scale.set(.0012,.0012,.0012),U.rotation.y=-1,U.position.set(9,0,-3),U.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),mixerCozinheiro=new e.AnimationMixer(U),t.animations.forEach(e=>{mixerCozinheiro.clipAction(e).play(),mixerCozinheiro.clipAction(e).clampWhenFinished=!0}),scene.add(U)}),galinha=new e.Object3D,W.load("chicken_walkcycle.glb",function(t){galinha.add(t.scene),galinha.scale.set(4e-4,4e-4,4e-4),galinha.rotation.y=1.5,galinha.position.set(-9,0,-8),galinha.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),mixergalinha=new e.AnimationMixer(galinha),t.animations.forEach(e=>{mixergalinha.clipAction(e).play(),mixergalinha.clipAction(e).clampWhenFinished=!0}),scene.add(galinha)});let N=new e.Object3D;W.load("poste.glb",function(e){N.add(e.scene),N.scale.set(.3,.3,.3),N.position.set(9.5,0,-14),scene.add(N)});let K=new e.Object3D;W.load("firewood02.glb",function(e){K.add(e.scene),K.scale.set(3,3,3),K.position.set(0,0,-14.2),K.rotation.y=1.5,scene.add(K)});let Z=new e.Object3D;W.load("message_board.glb",function(e){Z.add(e.scene),Z.scale.set(.6,.6,.6),Z.position.set(11.5,-.3,6.2),Z.rotation.y=.8,scene.add(Z)});let J=new e.Object3D;W.load("well.glb",function(e){J.add(e.scene),J.scale.set(1,1,1),J.position.set(-2,0,-5),scene.add(J)});let Q=new e.Object3D;W.load("druids_house_and_shop.glb",function(e){Q.add(e.scene),Q.scale.set(2.8,2.8,2.8),Q.position.set(-7.5,0,1.4),Q.rotation.y=1.6,Q.traverse(function(e){e.isMesh&&(e.castShadow=!0)}),scene.add(Q)});let X=new e.Object3D;W.load("sun.glb",function(e){X.add(e.scene),X.scale.set(.05,.05,.05),X.position.set(50,30,-50),X.rotation.y=1.6,scene.add(X)});let Y=new e.Object3D;W.load("lua.glb",function(e){Y.add(e.scene),Y.scale.set(5,5,5),Y.position.set(50,30,-100),Y.rotation.y=1.6});let ee=new e.Object3D;W.load("directional_arrow_1.glb",function(t){ee.add(t.scene),ee.scale.set(.03,.03,.03),ee.position.set(8,.5,-4.5),ee.rotation.y=2,mixerseta=new e.AnimationMixer(ee),t.animations.forEach(e=>{mixerseta.clipAction(e).play(),mixerseta.clipAction(e).clampWhenFinished=!0}),scene.add(ee)});let et=new e.Object3D;W.load("directional_arrow_1.glb",function(t){et.add(t.scene),et.scale.set(.03,.03,.03),et.position.set(7,.5,-12),et.rotation.y=2.5,mixerseta1=new e.AnimationMixer(et),t.animations.forEach(e=>{mixerseta1.clipAction(e).play(),mixerseta1.clipAction(e).clampWhenFinished=!0}),scene.add(et)});let en=new e.Object3D;W.load("directional_arrow_1.glb",function(t){en.add(t.scene),en.scale.set(.03,.03,.03),en.position.set(-7.5,.5,-13),en.rotation.y=3.5,mixerseta2=new e.AnimationMixer(en),t.animations.forEach(e=>{mixerseta2.clipAction(e).play(),mixerseta2.clipAction(e).clampWhenFinished=!0}),scene.add(en)});let ea=new e.Object3D;for(let eo=0;eo<30;eo++)W.load("pedra.glb",function(e){ea.add(e.scene),(rock=ea.clone()).scale.set(.1*Math.random()-.15,.1*Math.random()-.01,.1*Math.random()-.15),rock.position.set(20*Math.random()-10,0,20*Math.random()-15),scene.add(rock),window.innerWidth<768?scene.remove(rock):scene.add(rock)});let er=new e.Object3D;for(let ei=0;ei<20;ei++)W.load("clouds.glb",function(e){er.add(e.scene),(clouund=er.clone()).scale.x=.01,clouund.scale.z=.01,clouund.scale.y=.01*Math.random()-.001,clouund.position.set(100*Math.random()-55,15,100*Math.random()-55),clouund.traverse(function(e){e.isMesh&&(e.material.transparent=!0,e.material.opacity=.01)}),window.innerWidth<768?scene.remove(clouund):scene.add(clouund)});var es=new e.AmbientLight(16777215,.7);let el=new e.DirectionalLight(16580566,1);el.position.set(50,30,-50),el.castShadow=!0,el.shadow.camera.top=50,el.shadow.camera.bottom=-50,el.shadow.camera.left=-50,el.shadow.camera.right=50,el.shadow.camera.near=.1,el.shadow.camera.far=200,el.shadow.mapSize.width=4096,el.shadow.mapSize.height=4096,scene.add(el),scene.add(es);var ed=new e.AmbientLight(9605778,1);let ec=new e.DirectionalLight(11531263,1);ec.position.set(50,30,-100),ec.castShadow=!0,ec.shadow.camera.top=50,ec.shadow.camera.bottom=-50,ec.shadow.camera.left=-50,ec.shadow.camera.right=50,ec.shadow.camera.near=.1,ec.shadow.camera.far=200,ec.shadow.mapSize.width=4096,ec.shadow.mapSize.height=4096;let e$=new e.PointLight(16579698,10,10,1);e$.position.set(9.5,2,-13);let em=new e.PointLight(16719360,1,1,4);em.position.set(9,1,-4.5);let ep=new e.PointLight(16777215,10,40,0);ep.position.set(50,30,-80);let eh=new e.PointLight(65280,10,1,0);eh.position.set(8,.01,-4.5),scene.add(eh);let e_=new e.PointLight(65280,10,1,0);e_.position.set(7,.01,-12),scene.add(e_);let ef=new e.PointLight(65280,10,1,0);ef.position.set(-7.5,.01,-13),scene.add(ef);let ew=document.getElementById("screen");var eu=!1;mudardisplayBaixo=document.querySelector(".display"),mudardisplayAlto=document.getElementById("adicionar"),mudardisplayBaixo.addEventListener("click",()=>{renderer.shadowMap.enabled=!1,el.castShadow=!1,ec.castShadow=!1,scene.remove(ep),scene.remove(em),scene.remove(e$),scene.remove(passaro),scene.remove(eP),scene.remove(el),scene.remove(ec),scene.remove(galinha),scene.remove(clouund),eu=!0,ew.style.display="block",ew.addEventListener("animationend",function(){this.style.display="none"})}),mudardisplayAlto.addEventListener("click",()=>{renderer.shadowMap.enabled=!0,el.castShadow=!0,ec.castShadow=!0,scene.add(passaro),scene.add(eP),scene.add(el),scene.add(galinha),eu=!1,ew.style.display="block",ew.addEventListener("animationend",function(){this.style.display="none"})});let eb=[],ex=[];rainGeo=new e.BufferGeometry;for(let ey=0;ey<rainCount;ey++)rainDrop=new e.Vector3(400*Math.random()-200,500*Math.random()-250,400*Math.random()-200),eb.push(400*Math.random()-200),eb.push(500*Math.random()-250),eb.push(400*Math.random()-200),ex.push(30);rainGeo.setAttribute("position",new e.BufferAttribute(new Float32Array(eb),4)),rainGeo.setAttribute("size",new e.BufferAttribute(new Float32Array(ex),1));let ev=new e.PointsMaterial({color:14417149,size:.2,transparent:!0});rain=new e.Points(rainGeo,ev),_.addEventListener("click",function(){ew.addEventListener("animationend",function(){this.style.display="none"}),scene.fog=new e.FogExp2(1118495,.002),renderer.setClearColor(scene.fog.color),scene.remove(el),scene.remove(es),scene.remove(passaro),scene.remove(X),scene.add(Y),!0===eu?(scene.remove(ec),scene.remove(ep),scene.remove(em),scene.remove(e$)):(scene.add(ec),scene.add(e$),scene.add(em),scene.add(ep)),scene.add(ed),scene.add(rain),ew.style.display="block",_.style.display="none",f.style.display="block"}),f.addEventListener("click",function(){scene.fog=new e.FogExp2(8633855,.002),renderer.setClearColor(scene.fog.color),!0===eu?(scene.remove(el),scene.remove(passaro)):(scene.add(el),scene.add(passaro)),scene.add(es),scene.add(X),scene.remove(ep),scene.remove(em),scene.remove(e$),scene.remove(Y),scene.remove(ec),scene.remove(ed),scene.remove(rain),ew.style.display="block",_.style.display="block",f.style.display="none",ew.addEventListener("animationend",function(){this.style.display="none"})});let e1=`
    varying vec2 vUv;
    uniform float time;
    
        void main() {
        vUv = uv;
        
        vec4 mvPosition = vec4( position, 1.0 );
        #ifdef USE_INSTANCING
            mvPosition = instanceMatrix * mvPosition;
        #endif
        
        float dispPower = 1.0 - cos( uv.y * 3.1416 / 2.0 );
        
        float displacement = sin( mvPosition.z + time * 3.0 ) * ( 0.02 * dispPower );
        mvPosition.z += displacement;

        vec4 modelViewPosition = modelViewMatrix * mvPosition;
        gl_Position = projectionMatrix * modelViewPosition;

        }
    `,e3=`
    varying vec2 vUv;
    
    void main() {
        vec3 baseColor = vec3( 0.61, 1.0, 0.6 );
        float clarity = ( vUv.y * 0.35 ) + 0.00001;
        gl_FragColor = vec4( baseColor * clarity, 1 );
    }
    `;leavesMaterial=new e.ShaderMaterial({vertexShader:e1,fragmentShader:e3,uniforms:{time:{value:0}},side:e.DoubleSide});let eg=new e.Object3D,e0=new e.PlaneGeometry(.01,.2,1);e0.translate(0,.01,0);let eP=new e.InstancedMesh(e0,leavesMaterial,16e4);scene.add(eP);for(let eE=0;eE<16e4;eE++)eg.position.set((Math.random()-.48)*13.5,0,(Math.random()-.58)*11.2),eg.scale.setScalar(.8+.8*Math.random()),eg.rotation.y=Math.random()*Math.PI,eg.updateMatrix(),eP.setMatrixAt(eE,eg.matrix);for(let eC=0;eC<6e4;eC++)eg.position.set((Math.random()-.56)*11.5,0,(Math.random()-2.85)*5.23),eg.scale.setScalar(.8+.8*Math.random()),eg.rotation.y=Math.random()*Math.PI,eg.updateMatrix(),eP.setMatrixAt(eC,eg.matrix);for(let eM=0;eM<1e4;eM++)eg.position.set((Math.random()- -4.6)*1.8,0,(Math.random()-2.8)*5.2),eg.scale.setScalar(.8+.8*Math.random()),eg.rotation.y=Math.random()*Math.PI,eg.updateMatrix(),eP.setMatrixAt(eM,eg.matrix);keysPressed={},document.addEventListener("keydown",e=>{e.shiftKey&&characterControls?characterControls.switchRunToggle():keysPressed[e.key.toLowerCase()]=!0},!1),document.addEventListener("keyup",e=>{keysPressed[e.key.toLowerCase()]=!1},!1),window.addEventListener("resize",function(){camera.aspect=this.window.innerWidth/this.window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(this.window.innerWidth,this.window.innerHeight),labelRenderer.setSize(this.window.innerWidth,this.window.innerHeight)}),window.innerWidth<768&&alert("Coloque em tela cheia e vire a tela do seu celular!!"),animate()}let clock=new e.Clock;function animate(){let e=clock.getDelta();characterControls&&characterControls.update(e,keysPressed),mixer&&mixer.update(e),mixer3&&mixer3.update(e),mixerCozinheiro&&mixerCozinheiro.update(e),mixergalinha&&mixergalinha.update(e),mixerPassaro&&mixerPassaro.update(e),mixerVaca&&mixerVaca.update(e),mixerseta&&mixerseta.update(e),mixerseta1&&mixerseta1.update(e),mixerseta2&&mixerseta2.update(e),orbitControls.update(),!0==andando?(galinha.position.x+=.005,galinha.position.x>=9&&(andando=!1,galinha.rotation.y=-1.5)):(galinha.position.x-=.005,galinha.position.x<=-9&&(andando=!0,galinha.rotation.y=1.5)),!0==andandoPassaro?(passaro.position.x+=.03,passaro.position.x>=100&&(andandoPassaro=!1,passaro.rotation.y=1.5)):(passaro.position.x-=.03,passaro.position.x<=-100&&(andandoPassaro=!0,passaro.rotation.y=-1.5)),leavesMaterial.uniforms.time.value=clock.getElapsedTime(),leavesMaterial.uniformsNeedUpdate=!0,labelRenderer.render(scene,camera),renderer.render(scene,camera),requestAnimationFrame(animate)}init();